# ForenSight
ForenSight is a targeted prototype for identifying AgentTesla-like patterns in memory-derived RGB images. It follows MRm-DLDet-style preprocessing to convert memory dumps into RGB images, then uses a pretrained ResNet-18 backbone to extract embeddings and a prototype-based one-class detector (saved as a .npz) to decide whether the dump matches the learned AgentTesla profile.

# Installation & Setup
## Dependencies
### General
Please install the following tools:
- Oracle VirtualBox (Version >7.2.4 r170995)
- python (version >3.7)

### Python Libraries
Please ensure you have following python libraries:
-  pytorch
-  PIL
-  numpy
-  torchvision

## Generating Data for Analysis
First, you will have to generate a memory dump from a virtual machine, which we have provided an automated script (`VBoxControl.py`) in this repo. This step is the same as the one in MRm-DLDet's instruction. You may check their [repo here](https://github.com/C1air3/MRm-DLDet), and their [paper here](https://link.springer.com/article/10.1186/s42400-023-00157-w). You will need to have an active snapshot of a running Windows 10 virtual machine in VirtualBox, but make sure you have modified the `VBoxControl.py` script so it aligns with your virtual machine & snapshot's name, the virtual machine's username and password, etc. 
<p align="center">
  <img width="390" height="265" alt="image" src="https://github.com/user-attachments/assets/1d4f8a2f-131a-4f39-af5a-695033144f1f" /><br>
</p>

After doing so, you can run this command in the base folder on the terminal:
```
python3 VBoxControl.py
```
<br>

Then, run the `binary2RGBimg.py` script in the `Memory2RGBimg` folder. Don't forget to change these lines in the script so it aligns with your memory dump folder:
<p align="center">
  <img width="316" height="70" alt="image" src="https://github.com/user-attachments/assets/c9da44d9-87fb-4cd9-ae86-3cbc7b1f8315" /><br>
</p>

You may use the following script in the `Memory2RGBimg` folder on your terminal:
```
python3 binary2RGBimg.py
```
<br>

This process might take a while, depending on the specifications of your device. You should get a large image generated from your memory dump, which then you need to run `cut_photo.py` to slice the images into 625 fragments, each sized 224 x 224 pixels. You will also need to modify the script by adding the directory of the large image generated by `binary2RGBimg.py`, and the output folder of the fragments. 
<p align="center">
  <img width="352" height="35" alt="image" src="https://github.com/user-attachments/assets/8287770f-9dc1-42af-b792-5cc30034dcdc" /> <br>
</p>

You may use the following script in the `Memory2RGBimg` folder on your terminal:
```
python3 cut_photo.py
```
<br>

# Training
`ForenSight.py` provides 2 modes for the user, training and analysis. For training, you may use this script on the terminal:
```
python .\ForenSight.py train --train_root [data folder name] --out [model name].npz --topk [top-k value] --margin [margin size]
```
Running the script above, ForenSight will read the data from your cut images folder, and then output a .npz file. You may alter the top-k and margin for this process, which will affect the accuracy and detection for the model.
<img width="1792" height="236" alt="image" src="https://github.com/user-attachments/assets/1c96dac6-18d6-4309-91ca-d945f308bfb4" />


# Image Analysis
For analysis, you may use this script on the terminal:
```
python3 .\ForenSight.py infer --tiles_dir [directory containing images] --art [location of .npz file]
```
Running this script, ForenSight will analyze your cut images using the .npz file generated after training, giving outputs depending whether it resembles an Agent Tesla infected image or not. For example, here’s what the output of the program looks like if the image is infected with Agent Tesla:
<img width="1772" height="654" alt="image" src="https://github.com/user-attachments/assets/35325e77-2994-4bd8-92af-1bf8eb1296a3" />
The image above was simulated with a sample of a machine infected with Agent Tesla that wasn’t used in the training of the model. Seen in the image, the user will receive several information such as the total tiles read, distance to the prototype, the threshold, verdict whether it’s infected with Agent Tesla or not, and the top n (modifiable) tiles with the highest similarity. 

In the case of benign images or images not infected with AgentTesla, here is what the result will look like:
<img width="1852" height="582" alt="image" src="https://github.com/user-attachments/assets/38ed1ecc-4094-4248-bdfa-3a681a8bc4e0" />
As seen in the image, the output is still quite similar to the output for Agent Tesla infected images, apart from the verdict, showing “NOT_MATCHING_OR_UNKNOWN”.
**Do note that **NOT_MATCHING_OR_UNKNOWN** does not mean that the image itself is clean. It only concludes your memory dump does NOT resemble AgentTesla samples used in training**
